pipeline {
  agent any
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }
    stage('Docker Build and Push') {
      steps {
        script {
          podTemplate(yaml: '''
            apiVersion: v1
            kind: Pod
            spec:
              serviceAccountName: jenkins-admin
              volumes:
                - name: workspace
                  persistentVolumeClaim:
                    claimName: jenkins-pvc
                - name: docker-socket
                  emptyDir: {}
              containers:
                - name: docker
                  image: docker:19.03-dind
                  command: [sleep]
                  args: [99d]
                  volumeMounts:
                    - name: workspace
                      mountPath: /workspace
                    - name: docker-socket
                      mountPath: /var/run
                - name: kubectl
                  image: bitnami/kubectl:1.26.0
                  command: [sleep]
                  args: [99d]
          ''') {
            node(POD_LABEL) {
              container('docker') {
                sh 'docker build -t my-image .'
                sh 'docker push my-image'
              }
            }
          }
        }
      }
    }
  }
}
